---
title: "Data exploration and commentary"
author: "Paul Hively"
date: "March 29, 2016"
output: html_document
---

# Problem statement

My goal is to find a way to accurately forecast fundraising revenue.

The existing model has two components. First, the probability a solicitation $S_{i}$ comes in before the end of the fiscal year is a function of the current stage progress $c$ and time until the end of the year $t$, $P(S_{i}=1)=f(c_{i},t)$. The expected FRP in the current fiscal year is this probability times the expected amount, $E(FRP)=P(S_{i}=1)E(S_{i})$.

For the probability model, I assume that there should also be some effect due to the average close rate, season (e.g. people give more in December), planned ask amount, actual ask amount, and potentially interactions. Something like this:

$$P(S_{ij}=1)=f(c_{i},t,\mu,t_{i}^{*},a_{j}^{*},a_{j})$$

It makes sense to start with a few straightforward classifiers, but I'd also like to look into nesting models.

# Visualizations

The dataset includes all closed (successful or unsuccessful) solicitations with an add date on or after 7/1/2011. Data is obtained from the first tab of the "Booth solicitation history" report (saved as a .csv).

```{r, message=F, cache=T}
#### Run Rscript1 ----
source("Rscript1 - data load and transform.R")
#### Useful packages for data manipulation ----
library(dplyr); library(ggplot2); library(lubridate); library(tidyr); library(knitr); library(scales)
```

Begin with some visualizations of time in each stage:

```{r, echo=F, message=F, warning=F, cache=T}
Joe.dat2 <- read.csv("modeling.txt", sep="\t", stringsAsFactors=F)

#### Days between stages ----
ggdat <- Joe.dat2 %>%  mutate(
  plan2clear = as.numeric(difftime(Clear.Dt, Planning.Dt, units="days")),
  clear2ask = as.numeric(difftime(Ask.Dt, Clear.Dt, units="days")),
  ask2oral = as.numeric(difftime(Oral.Dt, Ask.Dt, units="days")),
  ask2actual = as.numeric(difftime(Actual.Dt, Ask.Dt, units="days")),
  oral2actual = as.numeric(difftime(Actual.Dt, Oral.Dt, units="days")),
  plan2actual = as.numeric(difftime(Actual.Dt, Planning.Dt, units="days")),
  giftsize = factor(ifelse(Expected.Amt>=5000000, 5000,
                    ifelse(Expected.Amt>=1000000, 1000,
                    ifelse(Expected.Amt>=100000,100,0))),
  labels=c("Under $100k","$100k+","$1M+","$5M+"))) %>%
# Only use closed solicitations; Stage 10=Booked, 12=Refused, 14=Cancelled, etc.
  filter(as.numeric(substr(Final.Sol.Stage,1,2)) >= 10)

## Create plots
ggplot(ggdat, aes(x=plan2clear, fill=giftsize)) + geom_density(alpha=.5) +
  facet_grid(giftsize~.) + labs(title="Days from planning to clearance") + xlim(c(0,1000))
ggplot(ggdat, aes(x=clear2ask, fill=giftsize)) + geom_density(alpha=.5) +
  facet_grid(giftsize~.) + labs(title="Days from clearance to ask")
ggplot(ggdat, aes(x=ask2actual, fill=giftsize)) + geom_density(alpha=.5) +
  facet_grid(giftsize~.) + labs(title="Days from ask to actual")
ggplot(ggdat, aes(x=plan2actual, fill=giftsize)) + geom_density(alpha=.5) +
  facet_grid(giftsize~.) + labs(title="Days from planning to actual")
```

There's extremely obvious bimodality in most cases. Note in particular that while PG is skewed positive overall, there seem to be two groups: takes a while and takes a *long* while. The purple "Days from ask to actual" is about as perfect a mixture of two $N(\mu_{k},\sigma^{2}_{k})$ as I've ever seen. Might be interesting to see if a certain population just takes longer.

```{r, echo=F, warning=F, cache=T}
## Ask and oral dates
ggplot(ggdat[ggdat$giftsize!="$5M+",], aes(x=ask2oral, fill=giftsize)) + geom_density(alpha=.5) + facet_grid(giftsize~.) + labs(title="Days from ask to oral")
ggplot(ggdat[ggdat$giftsize!="$5M+",], aes(x=oral2actual, fill=giftsize)) + geom_density(alpha=.5) + facet_grid(giftsize~.) + labs(title="Days from oral to actual")
```

There isn't much data in the oral pledge stage so things are a bit bumpier here.

Here's the cleaned up data file:
```{r, echo=F, warning=F, cache=T}
#### Model data cleanup ----

# Function to return end of the fiscal year
fye <- function(date){ymd(as.character(paste(round(month(date)/13)+year(date),"06","30", sep="-")))}

# Include only closed solicitations with Expected under $5M
mdat <- Joe.dat2 %>% filter(as.numeric(substr(Final.Sol.Stage,1,2)) >= 10 & Expected.Amt<5000000) %>%
  # Drop any solicitations where the actual date is before the start date
  mutate(plan2actual = as.numeric(difftime(Actual.Dt, Planning.Dt, units="days")),
         clear2actual = as.numeric(difftime(Actual.Dt, Clear.Dt, units="days")),
         ask2actual = as.numeric(difftime(Actual.Dt, Ask.Dt, units="days")),
         oral2actual = as.numeric(difftime(Actual.Dt, Oral.Dt, units="days"))) %>%
  filter(plan2actual>0) %>%
  # Determine the EOFY at the start of each stage
  mutate(planFYE = fye(Planning.Dt),
         clearFYE = fye(Clear.Dt),
         askFYE = fye(Ask.Dt),
         oralFYE = fye(Oral.Dt),
         # Did the solicitation close in the same FY as the stage
         FY.plan = Actual.Dt <= planFYE,
         FY.clear = Actual.Dt <= clearFYE,
         FY.ask = Actual.Dt <= askFYE,
         FY.oral = Actual.Dt <= oralFYE,
         planFYE = NULL, clearFYE = NULL, askFYE = NULL, oralFYE = NULL)
```
```{r, cache=T}
colnames(mdat)
```

**Booked** indicates whether the solicitation came in at $>$$0, and **FY.plan, FY.clear, FY.ask, FY.oral** indicate whether the solicitation closed in the same fiscal year as that stage was reached. Combinations of these five indicators will be the dependent variables. **plan2actual, clear2actual, ask2actual, oral2actual** are measured in days. The other covariates should be self-explanatory.

# Variable exploration

### Dependent variables

Do I want to model time to close from each current stage $c_{i}$ as opposed to $P(S_{ij}=1)$?

```{r, echo=F, warning=F, cache=T}
ggdat <- gather(mdat, "Stages","Days", 19:22) #gather() uses tidyr
ggplot(data=ggdat, aes(x=Stages, y=Days, color=Booked, fill=Booked)) + geom_boxplot(alpha=.4, position=position_dodge(width=1))
kable(summary(mdat[,19:22]))
```

Negative values indicate a data issue or update. Decidedly right-skewed. Try a square root transformation:

```{r, echo=F, warning=F, cache=T}
ggplot(data=ggdat, aes(x=Stages, y=sqrt(Days), color=Booked, fill=Booked)) + geom_boxplot(alpha=.4, position=position_dodge(width=1))
```

Not bad. How's log look?

```{r, echo=F, warning=F, cache=T}
ggplot(data=ggdat, aes(x=Stages, y=log(Days), color=Booked, fill=Booked)) + geom_boxplot(alpha=.4, position=position_dodge(width=1))
```

Might be a good idea to try e.g. Box-Cox transformations to see how they compare. 

Data counts - do I have enough to do what I want? Is it remotely reasonable to split by month or quarter?

```{r, echo=F, warning=F, cache=T}
## Group data by month
tmp <- mdat %>% mutate(Plan=as.numeric(month(Planned.Dt)),
                       Clear=as.numeric(month(Clear.Dt)),
                       Ask=as.numeric(month(Ask.Dt)),
                       Oral=as.numeric(month(Oral.Dt)), Count=1) %>%
  select(Count, Plan, Clear, Ask, Oral, Booked)

# Convert columns into rows
tmp2 <- gather(tmp, "Stage", "Month", 2:5) %>% mutate(Month=as.factor(Month))
levels(tmp2$Month) <- strtrim(month.name, 3) #use month names
tmp2$Month <- factor(tmp2$Month, levels(tmp2$Month)[c(7:12,1:6)]) #start in Jul instead of Jan
ggdat <- aggregate(Count ~ Stage + Month, FUN=sum, data=tmp2)
# Plot
ggplot(ggdat, aes(x=Month, y=Count, color=Stage, fill=Stage, group=Stage)) + geom_point() + geom_line() + labs(y="Count of solicitations entering stage") + theme(text=element_text(size=12))
# Table
kable(xtabs(Count ~ Stage + Month, data=ggdat))
```

Peak plan/ask occur around Nov-Dec and Mar each year. Not nearly as much oral pledge data; usually oral to booked is fast enough that the date isn't captured in the system. (The current model rolls ask and oral together.)

Finally, let's take a look at the booked versus declined solicitations by stage by fiscal year closed.

```{r, echo=F, warning=F, cache=T}
## Plot count of solicitations booked by month and stage
ggdat <- na.omit(tmp2)
ggplot(ggdat, aes(x=Month, color=Booked, fill=Booked)) + geom_bar(alpha=.4) + labs(y="Count of solicitations entering stage") + theme(text=element_text(size=12)) + facet_grid(Stage~.)
## Proportions
ggdat <- aggregate(Count ~ Stage + Month + Booked, FUN=sum, data=na.omit(tmp2))
tmp3 <- aggregate(Count ~ Stage + Month, FUN=sum, data=na.omit(tmp2))
# Convert each count in ggdat to a percent
for(i in 1:dim(ggdat)[1]){
  ggdat$Prop[i] <- ggdat$Count[i]/(tmp3$Count[tmp3$Stage==ggdat$Stage[i] & tmp3$Month==ggdat$Month[i]])
  # Binomial CIs, se^2 = p(1-p)/n
  ggdat$ci[i] <- sqrt((ggdat$Prop[i]*(1-ggdat$Prop[i]))/tmp3$Count[tmp3$Stage==ggdat$Stage[i] & tmp3$Month==ggdat$Month[i]])
}
## Plot
ggplot(ggdat, aes(x=Month, y=Prop, color=Booked, fill=Booked, group=Booked)) + geom_point() + geom_line(alpha=.4) + geom_ribbon(aes(ymin=Prop-ci, ymax=Prop+ci), alpha=.15) + labs(y="Proportion of solicitations entering stage") + theme(text=element_text(size=12)) + facet_grid(Stage~.) + scale_y_continuous(labels=percent)
```

Confidence bands are based on the variance for a binomial random variable, $\sqrt{\frac{p(1-p)}{n}}$ (assuming independence).

This is fascinating; a solicitation entering plan or clear in December through February is more likely to be refused rather than booked. Is there a specific year driving that?

```{r, echo=F, warning=F, error=F, cache=T}
## Redo previous plots for each fiscal year
tmp <- mdat %>% select(Planned.Dt, Clear.Dt, Ask.Dt, Oral.Dt, Booked) %>%
  mutate(Count=1, PlanY=as.numeric(year(Planned.Dt)), Plan=as.numeric(month(Planned.Dt)),
         ClearY=as.numeric(year(Clear.Dt)), Clear=as.numeric(month(Clear.Dt)),
         AskY=as.numeric(year(Ask.Dt)), Ask=as.numeric(month(Ask.Dt)),
         OralY=as.numeric(year(Oral.Dt)), Oral=as.numeric(month(Oral.Dt))) %>%
  select(-c(1:4)) #Drop actual dates which are now unneeded
# Spread month and year
tmp2 <- gather(tmp, "Stage", "Month", seq(4,10,by=2)) %>% gather("StageY", "Year", 3:6) %>%
  mutate(Month=as.factor(Month), Year=as.factor(Year), StageY=NULL)
levels(tmp2$Month) <- strtrim(month.name, 3) #use month names
tmp2$Month <- factor(tmp2$Month, levels(tmp2$Month)[c(7:12,1:6)]) #start in Jul instead of Jan
## Redo previous # plot for each fiscal year
ggdat <- aggregate(Count ~ Stage + Month + Year, FUN=sum, data=tmp2)
ggplot(ggdat, aes(x=Month, y=Count, color=Stage, fill=Stage, group=Stage)) + geom_point() + geom_line() + labs(y="Count of solicitations entering stage by year") + facet_grid(Year~.) + theme(text=element_text(size=12))
```

2010, 2016, 2017 don't have enough data so they're dropped from the second plot. 2011 didn't have much stage progress in the second half of the year.

```{r, echo=F, warning=F, cache=T}
## Data for plotting %s
ggdat <- aggregate(Count ~ Stage + Month + Year + Booked, FUN=sum, data=na.omit(tmp2))
tmp3 <- aggregate(Count ~ Stage + Month + Year, FUN=sum, data=na.omit(tmp2))
# Convert each count in ggdat to a percent
for(i in 1:dim(ggdat)[1]){
  ggdat$Prop[i] <- ggdat$Count[i]/(tmp3$Count[tmp3$Stage==ggdat$Stage[i] & tmp3$Month==ggdat$Month[i] & tmp3$Year==ggdat$Year[i]])
    # Binomial CIs, se^2 = p(1-p)/n
  ggdat$ci[i] <- sqrt((ggdat$Prop[i]*(1-ggdat$Prop[i]))/tmp3$Count[tmp3$Stage==ggdat$Stage[i] & tmp3$Month==ggdat$Month[i] & tmp3$Year==ggdat$Year[i]])
}
## Plot
ggplot(ggdat[!(ggdat$Year %in% c("2010","2016","2017")),], aes(x=Month, y=Prop, color=Booked, fill=Booked, group=Booked)) + geom_point() + geom_line(alpha=.4) + geom_ribbon(aes(ymin=Prop-ci, ymax=Prop+ci), alpha=.15) + labs(y="Proportion of solicitations entering stage") + facet_grid(Stage~Year) + scale_y_continuous(labels=percent) + theme(axis.text.x=element_text(angle=90, vjust=.4))
```

Looks like 2012 was a good year; other than that it's normal to have lots of duds in those winter months

### Covariates

I'm thinking time to close is not the natural outcome measure; a model predicting time to close can't be swapped out directly with the existing one. Recall from above:

> For the probability model, I assume that there should also be some effect due to the average close rate, season (e.g. people give more in December), planned ask amount, actual ask amount, and potentially interactions. Something like this:
>
> $$P(S_{ij}=1)=f(c_{i},t,\mu,t_{i}^{*},a_{j}^{*},a_{j})$$

Take a look at each of these variables against Booked.

```{r, echo=F, warning=F, cache=T}

```